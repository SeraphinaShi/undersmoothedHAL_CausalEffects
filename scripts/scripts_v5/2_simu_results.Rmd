---
title: "Simulations of estimating causal effects using undersmoothed HAL"
author: "Seraphina Shi"
date: "2023-05-10"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r load_lib, include = FALSE, warning=FALSE, message=FALSE, echo=FALSE}
library(here)
library(data.table)
library(dplyr)
library(tidyr)
library(foreach)

library(stringr)
library(glmnet)

library(origami)
library(hal9001)
library(tictoc)

library(R.utils)

library(pROC)

library(ggplot2)
library(cowplot)
library(gridExtra)
library(grid)
```

```{r setup, include = FALSE} 
plotFolder <- here("results","images", "v5")
if(!file.exists(plotFolder)) dir.create(plotFolder,recursive=TRUE)

knitr::opts_chunk$set(
  cache=FALSE, autodep=FALSE, warning=FALSE, message=FALSE, echo=FALSE,
  results = 'markup', dev='png', dpi=150, fig.align = "center", fig.path=paste0(plotFolder, "/"),
  cache.path=".cache/",
  duplicate.label="allow"
)

source(here("scripts", "scripts_v5", "1_visual_functions.R"))
```

# Simulation 1
Data structure:  $O = (W, A, Y)$

 * U - exogenous variables
 * W - baseline covariate that is a measure of body condition
 * A - treatment level based on W, continuous between 0 and 5
 * Y - outcome, indicator of an event 

 Underlying data generating process, $P_{U,X}$

* Exogenous variables:
  + $U_A \sim Normal(\mu=0, \sigma^2 = 1^2)$
  + $U_A \sim Normal(\mu=0, \sigma^2 = 2^2)$
  + $U_Y \sim Uniform(min = 0, max = 1)$

* Structural equations F and endogenous variables:
  + $W =  U_W$
  + $A = bound(2 - 0.5W + U_A, min=0, max=5)$
  + $Y = \mathbf{I}[U_Y < expit(-5 + W + 2.25A -0.5WA)]$

Outcome of interest: $E_0[Y|a,W]$, $a \in [0,5]$, the causal dose-response curve

```{r check_sys1}
generate_data_1 <- function(n, a=NA){
  # exogenous variables
  U_W <- rnorm(n, 0, 1)
  U_A <- rnorm(n, 0, 2)
  U_Y <- runif(n, 0, 1)
  
  # endogenous variables
  W <- U_W
  
  if(is.na(a)){
    A <-  2 - 0.5*W + U_A
    A[A<=0] = 0
    A[A>=5] = 5
  } else {
    A <- rep(a, n)
  }
  
  
  Y <- as.numeric(U_Y < plogis(-5 + W + 2.25*A - 0.5 * W * A ))
  
  # data frame
  O <- data.frame(W, A, Y)
  return(O)
}


DGS <- generate_data_1
sn = 1
```



# Simulation 2
Data structure:  $O = (W, A, Y)$

 * U - exogenous variables
 * W - baseline covariate that is a measure of body condition
 * A - treatment level based on W, continuous between 0 and 5
 * Y - outcome, indicator of an event 

 Underlying data generating process, $P_{U,X}$

* Exogenous variables:
  + $U_A \sim Normal(\mu=0, \sigma^2 = 1^2)$
  + $U_A \sim Normal(\mu=0, \sigma^2 = 2^2)$
  + $U_Y \sim Uniform(min = 0, max = 1)$

* Structural equations F and endogenous variables:
  + $W =  U_W$
  + $A = bound(2 - 0.5W + U_A, min=0, max=5)$
  + $Y = \mathbf{I}[U_Y < expit(-10 + 2W + 5sin(A^{1.5}) + 2WA)]$
  
Outcome of interest: $E_0[Y|a,W]$, $a \in [0,5]$, the causal dose-response curve

```{r check_sys2}
generate_data_2 <- function(n, a=NA){
  # exogenous variables
  U_W <- rnorm(n, 0, 1)
  U_A <- rnorm(n, 0, 2)
  U_Y <- runif(n, 0, 1)
  
  # endogenous variables
  W <- U_W
  
  if(is.na(a)){
    A <-  2 - 0.5*W + U_A
    A[A<=0] = 0
    A[A>=5] = 5
  } else {
    A <- rep(a, n)
  }
  
  
  Y <- as.numeric(U_Y < plogis(-10 + 2*W + 5*sin(A^1.5) + 2 * W * A ))
  
  # data frame
  O <- data.frame(W, A, Y)
  return(O)
}


DGS <- generate_data_2
sn = 2
```




# Simulation 3
Data structure:  $O = (W, A, Y)$

 * U - exogenous variables
 * W - baseline covariate that is a measure of body condition
 * A - treatment level based on W, continuous between 0 and 5
 * Y - outcome, indicator of an event 

 Underlying data generating process, $P_{U,X}$

* Exogenous variables:
  + $U_A \sim Normal(\mu=0, \sigma^2 = 1^2)$
  + $U_A \sim Normal(\mu=0, \sigma^2 = 2^2)$
  + $U_Y \sim Uniform(min = 0, max = 1)$

* Structural equations F and endogenous variables:
  + $W =  U_W$
  + $A = bound(2 - 0.5W + U_A, min=0, max=5)$
  + $Y = \mathbf{I}[U_Y < expit(-10 - 3W + 4A + \mathbf{I}(A>2) * 5sin((0.8A)^2 - 2.6)  )]$
  
Outcome of interest: $E_0[Y|a,W]$, $a \in [0,5]$, the causal dose-response curve

```{r check_sys3}

generate_data_3 <- function(n, a=NA){
  # exogenous variables
  U_W <- rnorm(n, 0, 1)
  U_A <- rnorm(n, 0, 2)
  U_Y <- runif(n, 0, 1)
  
  # endogenous variables
  W <- U_W
  
  if(is.na(a)){
    A <-  2 - 0.5*W + U_A
    A[A<=0] = 0
    A[A>=5] = 5
  } else {
    A <- rep(a, n)
  }
  
  Y <- as.numeric(U_Y < plogis(-10 - 3*W + 4*A + 5*sin((0.8*A)^2-2.6)*as.numeric(A > 2)) )
  
  # data frame
  O <- data.frame(W, A, Y)
  return(O)
}


DGS <- generate_data_3
sn = 3
```



# Simulation 4
```{r}
write_matex2 <- function(x) {
  begin <- "\\begin{bmatrix}"
  end <- "\\end{bmatrix}"
  X <-
    apply(x, 1, function(x) {
      paste(
        paste(x, collapse = "&"),
        "\\\\"
      )
    })
  paste(c(begin, X, end), collapse = "")
}

U_W_var <- matrix(c(1,        0.8,      0.9*1.5,     0.2*0.5,      0.1*0.3,
                      0.8,      1,        0.8*1.5,     0.3*0.5,      0.1*0.3, 
                      0.9*1.5,  0.8*1.5,  1.5^2,       0.1*0.5*1.5,  0.5*0.3*1.5,
                      0.2*0.5,  0.3*0.5,  0.1*0.5*1.5, 0.5^2,        0.75*0.3*0.5,
                      0.1*0.3,  0.1*0.3,  0.5*0.3*1.5, 0.75*0.3*0.5, 0.3^2), nrow = 5)

U_W_mu <- matrix(c(0, 0, 5, 1, 1), nrow=5)
```

Data structure:  $O = (W_1, W_2, W_3, W_4, W_5, A, Y)$

 * W - baseline covariates
 * A - treatment level based on W, continuous between 0 and 5
 * Y - outcome, indicator of an event 

 Underlying data generating process, $P_{U,X}$

* Exogenous variables:
  + $U_A \sim Normal(\mu=0, \sigma^2 = 1^2)$
  + $U_A \sim Normal(\mu=0, \sigma^2 = 2^2)$

* Structural equations F and endogenous variables:
  + $W \sim  N(\mu_W, \Sigma_W)$
  + $A = bound(0.1W_1 + 0.2W_2 + 0.5W_3 + 0.15W_4 - 0.05W_5 - 0.01W_3W_5 + U_A, min=0, max=5)$
  + $Y = \mathbf{I}[U_Y < expit(-7 -W_1 + 2W_2 - 0.5W_4 - W_1W_3 + 4A + 0.5AW_2)]$
    - where $\mu_W = `r write_matex2(U_W_mu)`$, and $\Sigma_W = `r write_matex2(U_W_var)`$

Outcome of interest: $E_0[Y|a,W]$, $a \in [0,5]$, the causal dose-response curve

```{r check_sys4}

generate_data_4 <- function(n, a=NA){
  # exogenous variables
  U_W_var <- matrix(c(1,        0.8,      0.9*1.5,     0.2*0.5,      0.1*0.3,
                      0.8,      1,        0.8*1.5,     0.3*0.5,      0.1*0.3, 
                      0.9*1.5,  0.8*1.5,  1.5^2,       0.1*0.5*1.5,  0.5*0.3*1.5,
                      0.2*0.5,  0.3*0.5,  0.1*0.5*1.5, 0.5^2,        0.75*0.3*0.5,
                      0.1*0.3,  0.1*0.3,  0.5*0.3*1.5, 0.75*0.3*0.5, 0.3^2), nrow = 5)
  U_W <- rmvnorm(n, mean = c(0, 0, 5, 1, 1), sigma = U_W_var)
  U_A <- rnorm(n, 0, 1)
  U_Y <- runif(n, 0, 1)
  
  # endogenous variables
  W <- data.frame(U_W)
  colnames(W) <- paste0('W', 1:ncol(W))
  
  if(is.na(a)){
    A <-  (0.1*W$W1 + 0.2*W$W2  + 0.5*W$W3 + 0.15*W$W4 - 0.05*W$W5 - 0.01*W$W3*W$W5 + U_A)
    A[A<=0] = 0
    A[A>=5] = 5
  } else {
    A <- rep(a, n)
  }

  Y <- as.numeric(U_Y < plogis(-7 - W$W1 + 2*W$W2 - 1*W$W1 * W$W3 - 0.5*W$W4 + 4*A + 0.5*A*W$W2 ))
  mean(Y)
  
  # data frame
  O <- W
  O$A = A
  O$Y = Y
  return(O)
}


DGS <- generate_data_4
sn = 4
```



# Simulation 5

Data structure:  $O = (W_1, W_2, W_3, W_4, W_5, A, Y)$

 * W - baseline covariates
 * A - treatment level based on W, continuous between 0 and 5
 * Y - outcome, indicator of an event 

 Underlying data generating process, $P_{U,X}$

* Exogenous variables:
  + $U_A \sim Normal(\mu=0, \sigma^2 = 1^2)$
  + $U_A \sim Normal(\mu=0, \sigma^2 = 2^2)$

* Structural equations F and endogenous variables:
  + $W \sim  N(\mu_W, \Sigma_W)$
  + $A = bound(0.1W_1 + 0.2W_2 + 0.5W_3 + 0.15W_4 - 0.05W_5 - 0.01W_3W_5 + U_A, min=0, max=5)$
  + $Y = \mathbf{I}[U_Y < expit(-10 -W_1 + 2W_2 - 0.5W_4 - 0.5W_1W_3 + 4A + \mathbf{I}(A>2) *5sin((0.8A)^2 - 2.6))]$
    - where $\mu_W = `r write_matex2(U_W_mu)`$, and $\Sigma_W = `r write_matex2(U_W_var)`$

Outcome of interest: $E_0[Y|a,W]$, $a \in [0,5]$, the causal dose-response curve

```{r check_sys5}
generate_data_5 <- function(n, a=NA){
  # exogenous variables
  U_W_var <- matrix(c(1,        0.8,      0.9*1.5,     0.2*0.5,      0.1*0.3,
                      0.8,      1,        0.8*1.5,     0.3*0.5,      0.1*0.3, 
                      0.9*1.5,  0.8*1.5,  1.5^2,       0.1*0.5*1.5,  0.5*0.3*1.5,
                      0.2*0.5,  0.3*0.5,  0.1*0.5*1.5, 0.5^2,        0.75*0.3*0.5,
                      0.1*0.3,  0.1*0.3,  0.5*0.3*1.5, 0.75*0.3*0.5, 0.3^2), nrow = 5)
  U_W <- rmvnorm(n, mean = c(0, 0, 5, 1, 1), sigma = U_W_var)
  U_A <- rnorm(n, 0, 1)
  U_Y <- runif(n, 0, 1)
  
  # endogenous variables
  W <- data.frame(U_W)
  colnames(W) <- paste0('W', 1:ncol(W))
  
  if(is.na(a)){
    A <-  (0.1*W$W1 + 0.2*W$W2  + 0.5*W$W3 + 0.15*W$W4 - 0.05*W$W5 - 0.01*W$W3*W$W5 + U_A)
    A[A<=0] = 0
    A[A>=5] = 5
  } else {
    A <- rep(a, n)
  }

  Y <- as.numeric(U_Y < plogis(-10 - W$W1 + 2*W$W2 - 0.5*W$W1 * W$W3 - 0.5*W$W4 + 4*A + 5*sin((0.8*A)^2-2.6)*as.numeric(A > 2)) )
  mean(Y)
  
  # data frame
  O <- W
  O$A = A
  O$Y = Y
  return(O)
}

DGS <- generate_data_5
sn = 5
```



# Simulation 6

Data structure:  $O = (W_1, W_2, W_3, A, Y)$

 * W - baseline covariates
 * A - treatment level based on W, continuous between 0 and 1
 * Y - outcome, indicator of an event 

 Underlying data generating process, $P_{U,X}$

* Structural equations F and endogenous variables:
  + $W_1 \sim Uniform(o,1)$
  + $W_2 \sim Bernoulli(\mu=0, \sigma^2 = 2^2)$
  + $W_3 \sim  N(W_1, 0.25*exp(2W_1))$
  + $A \sim Beta(v(W)\mu(W), v(W)[1-v(W)])$
  + $Y \sim Bernoulli(Q_0(A,W))$
    - where:
    - $v(W) = exp(1 + 2W_1expit(W3))$
    - $\mu(W) = expit(0.03 - 0.8log(1+W_2) + 0.9exp(W_1)W_2 - 0.4arctan(W_3+2)W_2W_1)$
    - $\bar{Q}_0(A,W) = expit(-2 + 1.5A + 5A^3 - 2.5W_1 + 0.5AW_2 - log(A)W_1W_2 + 0.5A^{3/4}W_1W_3)$

Outcome of interest: $E_0[Y|a,W]$, $a \in (0,1])$, the causal dose-response curve

```{r check_sys6}
expit <- function(x){
  return(exp(x)/(1+exp(x)))
}

generate_data_6 <- function(n, a=NA){
  W1 <- runif(n)
  W2 <- rbinom(n, size=1, prob =0.7)
  W3 <- rnorm(W1, 0.25*exp(2*W1))
  
  v_W <- exp(1 + 2*W1*expit(W3))
  mu_W <- expit(0.03 - 0.8*log(1+W2) + 0.9*exp(W1)*W2 - 0.4*atan(W3+2)*W2*W1)
  if(is.na(a)){
    A <- rbeta(n, v_W*mu_W, v_W*(1-mu_W))
  } else {
    A <- a
  }
  

  Q <- expit(-2 + 1.5*A + 5*A^3 - 2.5*W1 + 0.5*A*W2 - log(A)*W1*W2 + 0.5*(A^(3/4))*W1*W3)
  Y <- rbinom(n, size = 1, prob = Q)

  O <- data.frame(W1, W2,W3, A, Y)
  return(O)
}

DGS <- generate_data_6
sn = 6
```






