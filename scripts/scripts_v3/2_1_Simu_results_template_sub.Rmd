
### CV HAL
```{r}
load(here("data", "rdata", paste0("02_simu_V3_sys", sn, "_", nn, "_CV.RData")))
```

#### results
```{r simu_sys_n_1_cv, fig.width=6, fig.height=4}
set.seed(123)

cat(paste0("CV selected lambda (from one sample): ", unique(psi_10pnt$lambda)))


p1 <- plot_perforences_1lambda_alla(psi_10pnt, z_para=1, est_plot_only = T) +
  labs(title = "z=1") + theme(plot.title = element_text(hjust = 0.5))
p0 <- plot_perforences_1lambda_alla(psi_10pnt, z_para=0, est_plot_only = T) +
  labs(title = "z=0") + theme(plot.title = element_text(hjust = 0.5))

p <- grid.arrange(p1, p0, nrow=1,
                  top = textGrob(paste0("Average Treatment Effect,  E[Y|a,z] - E[Y|0,z]",
                                         gp=gpar(fontface = 'bold')))) # gp=gpar(fontsize=11, fontface = 'bold')

ggsave(here(getwd(), "plots", paste0("simu_sys", sn, "_z_n", nn ,"_1_cv.png")), p)
```

#### 1000 repetition 
```{r simu_sys_n_B_cv, fig.width=6, fig.height=7}
set.seed(123)
cat(paste0("The average of CV selected lambdas (from 1000 sample): ", unique(simu_results$result_summary$lambda)))

cat("z=1:")
p1_list <- plot_perforences_1lambda_alla(simu_results$result_summary, z_para=1, plot_list=F, add_oracal=T)
ggsave(here(getwd(), "plots", paste0("simu_sys", sn, "_z1", "_n", nn ,"_B_cv.png")), p1_list)

cat("z=0:")
p0_list <- plot_perforences_1lambda_alla(simu_results$result_summary, z_para=0, plot_list=F, add_oracal=T)
ggsave(here(getwd(), "plots", paste0("simu_sys", sn, "_z0", "_n", nn ,"_B_cv.png")), p0_list)


```

```{r simu_sys_n_B_cv_qq, fig.width=6, fig.height=4}
p1 <- estimation_qqplot(results_list = simu_results$all_results, z_para = 1)
p1
ggsave(here(getwd(), "plots", paste0("simu_sys", sn, "_z1", "_n", nn ,"_B_cv_qq.png")), p1)

p0 <- estimation_qqplot(results_list = simu_results$all_results, z_para = 0)
p0
ggsave(here(getwd(), "plots", paste0("simu_sys", sn, "_z0", "_n", nn ,"_B_cv_qq.png")), p0)

```

### Globally Undersmoothed HAL
```{r}
load(here("data", "rdata", paste0("02_simu_V3_sys", sn, "_", nn, "_U.RData")))
```

#### results
```{r simu_sys_n_1_u, fig.width=6, fig.height=4}
cat(paste0("Undersmoothed lambda: ", unique(psi_10pnt$lambda), 
           "\n which is ", unique(psi_10pnt$lambda)/unique(psi_10pnt$CV_lambda), " * lambda_CV"))


p1 <- plot_perforences_1lambda_alla(psi_10pnt, z_para=1, est_plot_only = T) +
  labs(title = "z=1") + theme(plot.title = element_text(hjust = 0.5))
p0 <- plot_perforences_1lambda_alla(psi_10pnt, z_para=0, est_plot_only = T) +
  labs(title = "z=0") + theme(plot.title = element_text(hjust = 0.5))

p <- grid.arrange(p1, p0, nrow=1,
                  top = textGrob(paste0("Average Treatment Effect,  E[Y|a,z] - E[Y|0,z]",
                                         gp=gpar(fontface = 'bold')))) # gp=gpar(fontsize=11, fontface = 'bold')

ggsave(here(getwd(), "plots", paste0("simu_sys", sn, "_z_n", nn ,"_1_u.png")), p)
```

#### 1000 repetition 
```{r simu_sys_n_B_u, fig.width=6, fig.height=7}
set.seed(123)

avg_u_scaler <- unique(simu_results$result_summary$lambda)/unique(simu_results$result_summary$CV_lambda)

cat(paste0("The average of unsersmoothed lambda (from 1000 sample): ", unique(simu_results$result_summary$lambda),
           "\n which is ", avg_u_scaler, " * the average of 1000 lambda_CV"))


cat("z=1:")
p1_list <- plot_perforences_1lambda_alla(simu_results$result_summary, z_para=1, plot_list=F, add_oracal=T)
ggsave(here(getwd(), "plots", paste0("simu_sys", sn, "_z1", "_n", nn ,"_B_u.png")), p1_list)

cat("z=0:")
p0_list <- plot_perforences_1lambda_alla(simu_results$result_summary, z_para=0, plot_list=F, add_oracal=T)
ggsave(here(getwd(), "plots", paste0("simu_sys", sn, "_z0", "_n", nn ,"_B_u.png")), p0_list)

```

```{r simu_sys_n_B_u_qq, fig.width=6, fig.height=4}
p1 <- estimation_qqplot(results_list = simu_results$all_results, z_para = 1)
p1
ggsave(here(getwd(), "plots", paste0("simu_sys", sn, "_z1", "_n", nn ,"_B_u_qq.png")), p1)

p0 <- estimation_qqplot(results_list = simu_results$all_results, z_para = 0)
p0
ggsave(here(getwd(), "plots", paste0("simu_sys", sn, "_z0", "_n", nn ,"_B_u_qq.png")), p0)

```

### Oevr a grid of lambda scalers

```{r simu_sys_n_B_grid}
if(grid=FALSE){
  knitr::knit_exit ()
}

load(here("data", "rdata", paste0("02_simu_V3_sys", sn, "_", nn, "_grid.RData")))
```

```{r simu_sys_n_B_grid_05_1, fig.height=5.5, fig.width=5.5}
plot_perforences_alllambda_1a(simu_results_all, a_para = 0.5, z_para = 1, add_oracal=T)
ggsave(here(getwd(), "plots", paste0("simu_sys", sn, "_z0", "_n", nn ,"_B_grid_a05_z1.png")))
```

```{r simu_sys_n_B_grid_2_1, fig.height=5.5, fig.width=5.5}
plot_perforences_alllambda_1a(simu_results_all, a_para = 2, z_para = 1, add_oracal=T)
ggsave(here(getwd(), "plots", paste0("simu_sys", sn, "_z0", "_n", nn ,"_B_grid_a2_z1.png")))
```

```{r simu_sys_n_B_grid_25_1, fig.height=5.5, fig.width=5.5}
plot_perforences_alllambda_1a(simu_results_all, a_para = 2.5, z_para = 1, add_oracal=T)
ggsave(here(getwd(), "plots", paste0("simu_sys", sn, "_z0", "_n", nn ,"_B_grid_a25_z1.png")))
```

```{r simu_sys_n_B_grid_3_1, fig.height=5.5, fig.width=5.5}
plot_perforences_alllambda_1a(simu_results_all, a_para = 3, z_para = 1, add_oracal=T)
ggsave(here(getwd(), "plots", paste0("simu_sys", sn, "_z0", "_n", nn ,"_B_grid_a3_z1.png")))
```

```{r simu_sys_n_B_grid_4_1, fig.height=5.5, fig.width=5.5}
plot_perforences_alllambda_1a(simu_results_all, a_para = 4, z_para = 1, add_oracal=T)
ggsave(here(getwd(), "plots", paste0("simu_sys", sn, "_z0", "_n", nn ,"_B_grid_a4_z1.png")))
```

```{r simu_sys_n_B_grid_5_1, fig.height=5.5, fig.width=5.5}
plot_perforences_alllambda_1a(simu_results_all, a_para = 5, z_para = 1, add_oracal=T)
ggsave(here(getwd(), "plots", paste0("simu_sys", sn, "_z0", "_n", nn ,"_B_grid_a5_z1.png")))
```


```{r simu_sys_n_B_grid_05_0, fig.height=5.5, fig.width=5.5}
plot_perforences_alllambda_1a(simu_results_all, a_para = 0.5, z_para = 0, add_oracal=T)
ggsave(here(getwd(), "plots", paste0("simu_sys", sn, "_z0", "_n", nn ,"_B_grid_a05_z0.png")))
```

```{r simu_sys_n_B_grid_2_0, fig.height=5.5, fig.width=5.5}
plot_perforences_alllambda_1a(simu_results_all, a_para = 2, z_para = 0, add_oracal=T)
ggsave(here(getwd(), "plots", paste0("simu_sys", sn, "_z0", "_n", nn ,"_B_grid_a2_z0.png")))
```

```{r simu_sys_n_B_grid_25_0, fig.height=5.5, fig.width=5.5}
plot_perforences_alllambda_1a(simu_results_all, a_para = 2.5, z_para = 0, add_oracal=T)
ggsave(here(getwd(), "plots", paste0("simu_sys", sn, "_z0", "_n", nn ,"_B_grid_a25_z0.png")))
```

```{r simu_sys_n_B_grid_3_0, fig.height=5.5, fig.width=5.5}
plot_perforences_alllambda_1a(simu_results_all, a_para = 3, z_para = 0, add_oracal=T)
ggsave(here(getwd(), "plots", paste0("simu_sys", sn, "_z0", "_n", nn ,"_B_grid_a3_z0.png")))
```

```{r simu_sys_n_B_grid_4_0, fig.height=5.5, fig.width=5.5}
plot_perforences_alllambda_1a(simu_results_all, a_para = 4, z_para = 0, add_oracal=T)
ggsave(here(getwd(), "plots", paste0("simu_sys", sn, "_z0", "_n", nn ,"_B_grid_a4_z0.png")))
```

```{r simu_sys_n_B_grid_5_0, fig.height=5.5, fig.width=5.5}
plot_perforences_alllambda_1a(simu_results_all, a_para = 5, z_para = 0, add_oracal=T)
ggsave(here(getwd(), "plots", paste0("simu_sys", sn, "_z0", "_n", nn ,"_B_grid_a5_z0.png")))
```

