---
title: "Simulations of estimating causal effects using undersmoothed HAL"
author: "Seraphina Shi"
date: "2023-03-17"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r load_lib, include = FALSE, warning=FALSE, message=FALSE, echo=FALSE}
library(here)
library(data.table)
library(dplyr)
library(tidyr)
library(foreach)

library(stringr)
library(glmnet)

library(origami)
library(hal9001)
library(tictoc)

library(R.utils)

library(pROC)

library(ggplot2)
library(cowplot)
library(gridExtra)
library(grid)
```

```{r setup, include = FALSE} 
plotFolder <- here("results","images", "v3")
if(!file.exists(plotFolder)) dir.create(plotFolder,recursive=TRUE)

knitr::opts_chunk$set(
  cache=FALSE, autodep=FALSE, warning=FALSE, message=FALSE, echo=FALSE,
  results = 'markup', dev='png', dpi=150, fig.align = "center", fig.path=paste0(plotFolder, "/"),
  cache.path=".cache/",
  duplicate.label="allow"
)

source(here("scripts", "scripts_v3", "1_simu_functions_hal9001.R"))
source(here("scripts", "scripts_v3", "1_simu_functions.R"))
source(here("scripts", "scripts_v3", "1_visual_functions.R"))
```

# Simulation 1
Data structure:  $O = (W, A, Z, Y)$

 * U - exogenous variables
 * W - baseline covariate that is a measure of body condition
 * A - treatment level based on W, continuous between 0 and 5
 * Z - intermediate curve based on W and A
 * Y - outcome, indicator of an event ?

 Underlying data generating process, $P_{U,X}$

* Exogenous variables:
  + $U_A \sim Normal(\mu=0, \sigma^2 = 1^2)$
  + $U_A \sim Normal(\mu=0, \sigma^2 = 2^2)$
  + $U_Z \sim Uniform(min = 0, max = 1)$
  + $U_Y \sim Uniform(min = 0, max = 1)$

* Structural equations F and endogenous variables:
  + $W =  U_W$
  + $A = bound(2 - 0.5W + U_A, min=0, max=5)$
  + $Z = \mathbf{I}[U_Z < expit(2-W-A)]$
  + $Y = \mathbf{I}[U_Y < expit(- 8 + W + 5A + Z - 0.5WA)]$


```{r check_sys1}
generate_data_1 <- function(n, a=NA, z=NA){
  # exogenous variables
  U_W <- rnorm(n, 0, 1)
  U_A <- rnorm(n, 0, 2)
  U_Z <- runif(n, 0, 1)
  U_Y <- runif(n, 0, 1)

  # endogenous variables
  W <- U_W

  if(is.na(a)){
    A <-  2 - 0.5*W + U_A
    A[A<=0] = 0
    A[A>=5] = 5
  } else {
    A <- rep(a, n)
  }

  if(is.na(z)){
    Z <- as.numeric(U_Z < plogis(2-W-A))
  } else {
    Z <- rep(z, n)
  }

  Y <- as.numeric(U_Y < plogis(W + 5*A + Z - 0.5 * W * A - 8))

  # data frame
  O <- data.frame(W, A, Z, Y)
  return(O)
}

DGS <- generate_data_1
sn = 1
```

```{r child = '2_1_Simu_results_template.Rmd'}
```




<!-- # Simulation 2 -->

<!-- Data structure:  $O = (W, A, Z, Y)$ -->

<!--  * U - exogenous variables -->
<!--  * W - baseline covariate that is a measure of body condition -->
<!--  * A - treatment level based on W, continuous between 0 and 5 -->
<!--  * Z - intermediate curve based on W and A -->
<!--  * Y - outcome, indicator of an event ? -->

<!--  Underlying data generating process, $P_{U,X}$ -->

<!-- * Exogenous variables: -->
<!--   + $U_A \sim Normal(\mu=0, \sigma^2 = 1^2)$ -->
<!--   + $U_A \sim Normal(\mu=0, \sigma^2 = 2^2)$ -->
<!--   + $U_Z \sim Uniform(min = 0, max = 1)$ -->
<!--   + $U_Y \sim Uniform(min = 0, max = 1)$ -->

<!-- * Structural equations F and endogenous variables: -->
<!--   + $W =  U_W$ -->
<!--   + $A = bound(2 - 0.5W + U_A, min=0, max=5)$ -->
<!--   + $Z = \mathbf{I}[U_Z < expit(2-W-A)]$ -->
<!--   + $Y = \mathbf{I}[U_Y < expit(-15 - 4W + 5A + Z(10 + 5W + 2AW))]$ -->


<!-- ```{r check_sys2} -->
<!-- generate_data_2 <- function(n, a=NA, z=NA){ -->
<!--   # exogenous variables -->
<!--   U_W <- rnorm(n, 0, 1) -->
<!--   U_A <- rnorm(n, 0, 2) -->
<!--   U_Z <- runif(n, 0, 1) -->
<!--   U_Y <- runif(n, 0, 1) -->

<!--   # endogenous variables -->
<!--   W <- U_W -->

<!--   if(is.na(a)){ -->
<!--     A <-  2 - 0.5*W + U_A -->
<!--     A[A<=0] = 0 -->
<!--     A[A>=5] = 5 -->
<!--   } else { -->
<!--     A <- rep(a, n) -->
<!--   } -->

<!--   if(is.na(z)){ -->
<!--     Z <- as.numeric(U_Z < plogis(2-W-A)) -->
<!--   } else { -->
<!--     Z <- rep(z, n) -->
<!--   } -->

<!--   Y <- as.numeric(U_Y < plogis(-4 * W + 5*A + 10*Z + 5*W*Z + 2 * A * Z * W - 15)) -->

<!--   # data frame -->
<!--   O <- data.frame(W, A, Z, Y) -->
<!--   return(O) -->
<!-- } -->

<!-- DGS <- generate_data_2 -->
<!-- sn = 2 -->
<!-- ``` -->

<!-- ```{r child = '2_1_Simu_results_template.Rmd'} -->
<!-- ``` -->


<!-- # Simulation 3 -->
<!-- Data structure:  $O = (W, A, Z, Y)$  -->

<!--  * U - exogenous variables   -->
<!--  * W - baseline covariate that is a measure of body condition   -->
<!--  * A - treatment level based on W, continuous between 0 and 5   -->
<!--  * Z - intermediate curve based on W and A -->
<!--  * Y - outcome, indicator of an event ?   -->

<!--  Underlying data generating process, $P_{U,X}$ -->

<!-- * Exogenous variables:   -->
<!--   + $U_A \sim Normal(\mu=0, \sigma^2 = 1^2)$   -->
<!--   + $U_A \sim Normal(\mu=0, \sigma^2 = 2^2)$   -->
<!--   + $U_Z \sim Uniform(min = 0, max = 1)$   -->
<!--   + $U_Y \sim Uniform(min = 0, max = 1)$   -->

<!-- * Structural equations F and endogenous variables:   -->
<!--   + $W =  U_W$   -->
<!--   + $A = bound(2 - 0.5W + U_A, min=0, max=5)$   -->
<!--   + $Z = \mathbf{I}[U_Z < expit(2-W-A)]$ -->
<!--   + $Y = \mathbf{I}[U_Y < expit(-10 - 3W + 2A + 10Z + Z(10 + 5W + 2AW))]$ -->

<!-- ```{r check_sys3} -->
<!-- generate_data_3 <- function(n, a=NA, z=NA){ -->
<!--   # exogenous variables -->
<!--   U_W <- rnorm(n, 0, 1) -->
<!--   U_A <- rnorm(n, 0, 2) -->
<!--   U_Z <- runif(n, 0, 1) -->
<!--   U_Y <- runif(n, 0, 1) -->

<!--   # endogenous variables -->
<!--   W <- U_W -->

<!--   if(is.na(a)){ -->
<!--     A <-  2 - 0.5*W + U_A -->
<!--     A[A<=0] = 0 -->
<!--     A[A>=5] = 5 -->
<!--   } else { -->
<!--     A <- rep(a, n) -->
<!--   } -->

<!--   if(is.na(z)){ -->
<!--     Z <- as.numeric(U_Z < plogis(2-W-A)) -->
<!--   } else { -->
<!--     Z <- rep(z, n) -->
<!--   } -->

<!--   Y <- as.numeric(U_Y < plogis(-10 - 3*W + 2*A + Z * (5 + 2*sin(A^2) -20*as.numeric(a > 4)) )) -->

<!--   # data frame -->
<!--   O <- data.frame(W, A, Z, Y) -->
<!--   return(O) -->
<!-- } -->

<!-- DGS <- generate_data_3 -->
<!-- sn = 3 -->
<!-- ``` -->

<!-- ```{r child = '2_1_Simu_results_template.Rmd'} -->
<!-- ``` -->