---
title: "Simulations of estimating causal effects using undersmoothed HAL"
author: "Seraphina Shi"
date: "2022-09-06"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r load_lib, include = FALSE, warning=FALSE, message=FALSE, echo=FALSE}
library(here)
library(data.table)
library(dplyr)
library(tidyr)
library(foreach)

library(stringr)
library(glmnet)

library(origami)
library(hal9001)
library(tictoc)

library(R.utils)

library(pROC)

library(ggplot2)
library(gridExtra)
library(grid)
```

```{r setup, include = FALSE} 
plotFolder <- here("results","images", "v2")
if(!file.exists(plotFolder)) dir.create(plotFolder,recursive=TRUE)

knitr::opts_chunk$set(
  cache=FALSE, autodep=FALSE, warning=FALSE, message=FALSE, echo=FALSE,
  results = 'markup', dev='png', dpi=150, fig.align = "center", fig.path=plotFolder,
  cache.path=".cache/",
  duplicate.label="allow"
)

source(here("scripts", "scripts_v1", "1_simu_functions_hal9001.R"))
source(here("scripts", "scripts_v1", "1_simu_functions.R"))
```

# Simulation #1
Data structure:  $O = (W, A, Z, Y)$ 

 * U - exogenous variables  
 * W - baseline covariate that is a measure of body condition  
 * A - treatment level based on W, continuous between 0 and 5  
 * Z - intermediate curve based on W and A
 * Y - outcome, indicator of an event ?  
   
 Underlying data generating process, $P_{U,X}$
 
* Exogenous variables:  
  + $U_A \sim Normal(\mu=0, \sigma^2 = 1^2)$  
  + $U_A \sim Normal(\mu=0, \sigma^2 = 2^2)$  
  + $U_Z \sim Uniform(min = 0, max = 1)$  
  + $U_Y \sim Uniform(min = 0, max = 1)$  
  
* Structural equations F and endogenous variables:  
  + $W =  U_W$  
  + $A = bound(2 - 0.5W + U_A, min=0, max=5)$  
  + $Z = \mathbf{I}[U_Z < expit(2-W-A)]$
  + $Y = \mathbf{I}[U_Y < expit(W + 5*A + Z - 0.5 * W * A - 8)]$


```{r}
generate_data_1 <- function(n, a=NA, z=NA){
  # exogenous variables
  U_W <- rnorm(n, 0, 1)
  U_A <- rnorm(n, 0, 2)
  U_Z <- runif(n, 0, 1)
  U_Y <- runif(n, 0, 1)
  
  # endogenous variables
  W <- U_W
  
  if(is.na(a)){
    A <-  2 - 0.5*W + U_A
    A[A<=0] = 0
    A[A>=5] = 5
  } else {
    A <- rep(a, n)
  }
  
  if(is.na(z)){
    Z <- as.numeric(U_Z < plogis(2-W-A))
  } else {
    Z <- rep(z, n)
  }
  
  Y <- as.numeric(U_Y < plogis(W + 5*A + Z - 0.5 * W * A - 8))
  
  # data frame
  O <- data.frame(W, A, Z, Y)
  return(O)
}

obs <- generate_data_1(n=10000)
print(summary(obs))
  
# check positivity violations
cat("Summary of A given W < -1:")
summary(obs$A[obs$W < -1])
cat("Summary of A given -1 < W <= 0:")
summary(obs$A[-1 <= obs$W & obs$W < 0])
cat("Summary of A given 0 < W <= 1:")
summary(obs$A[0 <= obs$W & obs$W < 1])
cat("Summary of A given 1 < W:")
summary(obs$A[1 <= obs$W])

par(mfrow=c(2,3))
plot(obs$W,obs$A)
plot(obs$A,obs$Z)
plot(obs$Z,obs$Y)
plot(obs$W,obs$Z)
plot(obs$W,obs$Y)
plot(obs$A,obs$Y)

# glm_fit <- glm(formula = Y ~ W + A + W*A + Z,
#                family = binomial,
#                data = obs)
# summary(glm_fit)
# y_preds <- predict(glm_fit, type = "response")
# mse <- sum((y_preds - obs$Y)^2)
# auc <- auc(obs$Y, y_preds)
# print(paste0("    MSE: ", round(mse, 4), ", AUC: ", round(auc, 4)))
```


```{r get_true_psis_1}
# Getting trul value of psi
# a_vec <- seq(0.5,5,0.5)
# psi0_a_0 <- c()
# psi0_a_1 <- c()
# 
# N = 1e+07
# data_0_0 <- generate_data_1(n=N, a=0, z=0)
# data_0_1 <- generate_data_1(n=N, a=0, z=1)
# 
# for (i in 1:length(a_vec)) {
#   a <- a_vec[i]
# 
#   data_a_0 <- generate_data_1(n=N, a=a, z=0)
#   psi0_a_0[i] <- mean(data_a_0$Y - data_0_0$Y)
# 
#   data_a_1 <- generate_data_1(n=N, a=a, z=1)
#   psi0_a_1[i] <- mean(data_a_1$Y - data_0_1$Y)
# }
# rm(data_0_0, data_0_1, data_a_0, data_a_1)
```



## n = 200
```{r simu_1_n200}
# set.seed(123)
# n=200
# B=1000
# lambda_scalers <- c(1.2, 1.1, 10^seq(from=0, to=-3, length=30))
# results_200 = run_simu(generate_data = generate_data_1, n=n, B=B, get_estimates = TRUE)
# save.image(file=here("data", "rdata", "02_simulation_1_200.RData"))
```
```{r}
load(here("data", "rdata", "02_simulation_1_200.RData"))
```

### results
```{r}
cat("Initial lambda mean:", results_200$lambda_scaler_1$lambda_summary[1,1])
cat("The selected undersmoothed lambda mean:", 0.0001128359)
cat("The scaler picked:", round(0.0001128359/results_200$lambda_scaler_1$lambda_summary[1,1],4))
```


#### CIs
```{r simu1_n200_CI_over_penalties, fig.height=22, fig.width=8}
p_list <- list()
for(z in c(0,1)){
  for (targ_par in paste0("ATE(",a_vec,",0)")) {
    p_list <- append(p_list, list(plot_perforences(results_200, z_para = z, target_para = targ_par, CI_forest_plot=T, scaler_picked = (0.0001128359/0.0082549535))))
  }
}

gridExtra::grid.arrange(grobs = p_list, ncol = 2,
                        top = textGrob("Estimations of ATEs \nfrom HAL over a grid of penalties",
                                       gp = gpar(fontsize = 20),  hjust = 0.5))
```

```{r simu1_n200_CIs_true_psi, fig.height=5, fig.width=6}
tmp_df <- data.frame(rep(a_vec,2), 
                     psi0 = rep(c(psi0_a_0, psi0_a_1), 2), 
                     z = as.factor(rep(rep(c(0,1),each=length(a_vec)),2)), 
                     targ_par=rep(paste0("ATE(",a_vec,",0)"),2), 
                     psi_hat = c(results_200$lambda_scaler_0.1172$`ATE_z=0`$mean_init, 
                                    results_200$lambda_scaler_0.1172$`ATE_z=1`$mean_init,
                                    results_200$lambda_scaler_0.1172$`ATE_z=0`$mean_under, 
                                    results_200$lambda_scaler_0.1172$`ATE_z=1`$mean_under),
                     ci_upper = c(results_200$lambda_scaler_0.1172$`ATE_z=0`$mean_init +
                                       1.96*results_200$lambda_scaler_0.1172$`ATE_z=0`$sd_i, 
                                    results_200$lambda_scaler_0.1172$`ATE_z=1`$mean_init+
                                       1.96*results_200$lambda_scaler_0.1172$`ATE_z=1`$sd_i,
                                  results_200$lambda_scaler_0.1172$`ATE_z=0`$mean_under +
                                       1.96*results_200$lambda_scaler_0.1172$`ATE_z=0`$sd_u, 
                                    results_200$lambda_scaler_0.1172$`ATE_z=1`$mean_under+
                                       1.96*results_200$lambda_scaler_0.1172$`ATE_z=1`$sd_u),
                     ci_lower = c(results_200$lambda_scaler_0.1172$`ATE_z=0`$mean_init -
                                       1.96*results_200$lambda_scaler_0.1172$`ATE_z=0`$sd_i, 
                                    results_200$lambda_scaler_0.1172$`ATE_z=1`$mean_ini -
                                       1.96*results_200$lambda_scaler_0.1172$`ATE_z=1`$sd_i,
                                    results_200$lambda_scaler_0.1172$`ATE_z=0`$mean_under -
                                       1.96*results_200$lambda_scaler_0.1172$`ATE_z=0`$sd_u, 
                                    results_200$lambda_scaler_0.1172$`ATE_z=1`$mean_under -
                                       1.96*results_200$lambda_scaler_0.1172$`ATE_z=1`$sd_u),
                     lambda = c(rep("CV", (2*length(a_vec))), rep("g_u", (2*length(a_vec))))
                    )


p1 <- ggplot(data=tmp_df[tmp_df$z==1 & tmp_df$lambda=="CV",], 
            aes(x=a_vec, 
                y=psi_hat, ymin=ci_lower, ymax=ci_upper,
                color = lambda)) +
      geom_point(shape=24, size=2) +
      geom_errorbar(shape=24, width=0.3) + 
      geom_point(aes(x = a_vec, y = psi0), color = "black") +
      labs(x="a", y="ATE") +
      ggtitle("Z=1, CV-penalty")+
      theme(plot.title = element_text(hjust = 0.5), #size=8.6, 
            #axis.title.y = element_blank(),
            panel.grid.major.x = element_blank(),
            #axis.text.y = element_text(size=8),
            #axis.title.x = element_text(size=8),
            axis.text = element_text(size=7),
            legend.position="none")  
p2 <- ggplot(data=tmp_df[tmp_df$z==1 & tmp_df$lambda=="g_u",], 
            aes(x=a_vec, 
                y=psi_hat, ymin=ci_lower, ymax=ci_upper,
                color = lambda)) +
      geom_point(shape=24, size=2) +
      geom_errorbar(shape=24, width=0.3) + 
      geom_point(aes(x = a_vec, y = psi0), color = "black") +
      labs(x="a", y="ATE") +
      ggtitle("Z=1, globally undersmoothed penalty")+
      theme(plot.title = element_text(hjust = 0.5), #size=8.6, 
            #axis.title.y = element_blank(),
            panel.grid.major.x = element_blank(),
            #axis.text.y = element_text(size=8),
            #axis.title.x = element_text(size=8),
            axis.text = element_text(size=7),
            legend.position="none")  

p3 <- ggplot(data=tmp_df[tmp_df$z==0 & tmp_df$lambda=="CV",], 
            aes(x=a_vec, 
                y=psi_hat, ymin=ci_lower, ymax=ci_upper,
                color = lambda)) +
      geom_point(shape=24, size=2) +
      geom_errorbar(shape=24, width=0.3) + 
      geom_point(aes(x = a_vec, y = psi0), color = "black") +
      labs(x="a", y="ATE") +
      ggtitle("Z=0, CV-penalty")+
      theme(plot.title = element_text(hjust = 0.5), #size=8.6, 
            #axis.title.y = element_blank(),
            panel.grid.major.x = element_blank(),
            #axis.text.y = element_text(size=8),
            #axis.title.x = element_text(size=8),
            axis.text = element_text(size=7),
            legend.position="none")  

p4 <- ggplot(data=tmp_df[tmp_df$z==0 & tmp_df$lambda=="g_u",], 
            aes(x=a_vec, 
                y=psi_hat, ymin=ci_lower, ymax=ci_upper,
                color = lambda)) +
      geom_point(shape=24, size=2) +
      geom_errorbar(shape=24, width=0.3) + 
      geom_point(aes(x = a_vec, y = psi0), color = "black") +
      labs(x="a", y="ATE") +
      ggtitle("Z=0, globally undersmoothed penalty")+
      theme(plot.title = element_text(hjust = 0.5), #size=8.6, 
            #axis.title.y = element_blank(),
            panel.grid.major.x = element_blank(),
            #axis.text.y = element_text(size=8),
            #axis.title.x = element_text(size=8),
            axis.text = element_text(size=7),
            legend.position="none")  

grid.arrange(p1,p2,p3,p4, nrow=2, top = "Oracle CIs from CV-HAL and Globally Undersmoothed HAL")
```


#### psi(a=0.5, z= 1)
```{r simu1_n200_ATE_0.5_0_z1, fig.height=5.5, fig.width=5.5}
p <- plot_perforences(results_200, z_para = 1, target_para = "ATE(0.5,0)")
```

#### psi(a=5, z= 1)

```{r simu1_n200_ATE_5_0_z1, fig.height=5.5, fig.width=5.5}
p <- plot_perforences(results_200, z_para = 1, target_para = "ATE(5,0)")
```

#### psi(a=0.5, z= 0)
Estimating ATE(0.5,0) with z  = 0
```{r simu1_n200_ATE_0.5_0_z0, fig.height=5.5, fig.width=5.5}
p <- plot_perforences(results_200, z_para = 0, target_para = "ATE(0.5,0)")
```

#### psi(a=5, z= 0)

```{r simu1_n200_ATE_5_0_z0, fig.height=5.5, fig.width=5.5}
p <- plot_perforences(results_200, z_para = 0, target_para = "ATE(5,0)")
```


<!-- ## n = 500 -->
<!-- ```{r simu_1_n500} -->
<!-- set.seed(123) -->
<!-- n=500 -->
<!-- B=1000 -->
<!-- lambda_scalers <- c(1.2, 1.1, 10^seq(from=0, to=-3, length=30)) -->
<!-- results_500 = run_simu(generate_data = generate_data_1, n=n, B=B, get_estimates = TRUE) -->
<!-- save.image(file=here("data", "rdata", "02_simulation_1_500.RData")) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- load(here("data", "rdata", "02_simulation_1_500.RData")) -->
<!-- ``` -->

<!-- ### results -->
<!-- ```{r} -->
<!-- cat("Initial lambda mean:", results_500$lambda_scaler_1$lambda_summary[1,1]) -->
<!-- cat("The selected undersmoothed lambda mean:", 0.00003787267) -->
<!-- scaler_picked = 0.00003787267/results_500$lambda_scaler_1$lambda_summary[1,1] -->
<!-- cat("The scaler picked:", scaler_picked) -->
<!-- ``` -->

<!-- #### CIs -->
<!-- ```{r fig.height=22, fig.width=8} -->
<!-- p_list <- list() -->
<!-- for(z in c(0,1)){ -->
<!--   for (targ_par in results_500$lambda_scaler_1$`ATE_z=1`$targ_par) { -->
<!--     p_list <- append(p_list, list(plot_perforences(results_500, z_para = z, target_para = targ_par, CI_forest_plot=T, scaler_picked = scaler_picked))) -->
<!--   } -->
<!-- } -->

<!-- gridExtra::grid.arrange(grobs = p_list, ncol = 2, -->
<!--                         top = textGrob("Estimations of ATEs \nfrom HAL over a grid of penalties", -->
<!--                                        gp = gpar(fontsize = 20),  hjust = 0.5)) -->
<!-- ``` -->

<!-- #### psi(a=0.5, z= 1) -->
<!-- ```{r, fig.height=5.5, fig.width=5.5} -->
<!-- p <- plot_perforences(results_500, z_para = 1, target_para = "ATE(0.5,0)") -->
<!-- ``` -->

<!-- #### psi(a=5, z= 1) -->

<!-- ```{r, fig.height=5.5, fig.width=5.5} -->
<!-- p <- plot_perforences(results_500, z_para = 1, target_para = "ATE(5,0)") -->
<!-- ``` -->

<!-- #### psi(a=0.5, z= 0) -->
<!-- Estimating ATE(0.5,0) with z  = 0 -->
<!-- ```{r, fig.height=5.5, fig.width=5.5} -->
<!-- p <- plot_perforences(results_500, z_para = 0, target_para = "ATE(0.5,0)") -->
<!-- ``` -->

<!-- #### psi(a=5, z= 0) -->

<!-- ```{r, fig.height=5.5, fig.width=5.5} -->
<!-- p <- plot_perforences(results_500, z_para = 0, target_para = "ATE(5,0)") -->
<!-- ``` -->

# Simulation #1_1
[Same as Simulation #1, but with posibility violation as the variance of U_A decreased]    
Data structure:  $O = (W, A, Z, Y)$ 

 * U - exogenous variables  
 * W - baseline covariate that is a measure of body condition  
 * A - treatment level based on W, continuous between 0 and 5  
 * Z - intermediate curve based on W and A
 * Y - outcome, indicator of an event ?  
   
 Underlying data generating process, $P_{U,X}$
 
* Exogenous variables:  
  + $U_A \sim Normal(\mu=0, \sigma^2 = 1^2)$  
  + $U_A \sim Normal(\mu=0, \sigma^2 = 1^2)$  
  + $U_Z \sim Uniform(min = 0, max = 1)$  
  + $U_Y \sim Uniform(min = 0, max = 1)$  
  
* Structural equations F and endogenous variables:  
  + $W =  U_W$  
  + $A = bound(2 - 0.5W + U_A, min=0, max=5)$  
  + $Z = \mathbf{I}[U_Z < expit(2-W-A)]$
  + $Y = \mathbf{I}[U_Y < expit(W + 5*A + Z - 0.5 * W * A - 8)]$


```{r}
generate_data_1_1 <- function(n, a=NA, z=NA){
  # exogenous variables
  U_W <- rnorm(n, 0, 1)
  U_A <- rnorm(n, 0, 1)
  U_Z <- runif(n, 0, 1)
  U_Y <- runif(n, 0, 1)
  
  # endogenous variables
  W <- U_W
  
  if(is.na(a)){
    A <-  2 - 0.5*W + U_A
    A[A<=0] = 0
    A[A>=5] = 5
  } else {
    A <- rep(a, n)
  }
  
  if(is.na(z)){
    Z <- as.numeric(U_Z < plogis(2-W-A))
  } else {
    Z <- rep(z, n)
  }
  
  Y <- as.numeric(U_Y < plogis(W + 5*A + Z - 0.5 * W * A - 8))
  
  # data frame
  O <- data.frame(W, A, Z, Y)
  return(O)
}

obs <- generate_data_1_1(n=10000)
print(summary(obs))
  
# check positivity violations
cat("Summary of A given W < -1:")
summary(obs$A[obs$W < -1])
cat("Summary of A given -1 < W <= 0:")
summary(obs$A[-1 <= obs$W & obs$W < 0])
cat("Summary of A given 0 < W <= 1:")
summary(obs$A[0 <= obs$W & obs$W < 1])
cat("Summary of A given 1 < W:")
summary(obs$A[1 <= obs$W])

par(mfrow=c(2,3))
plot(obs$W,obs$A)
plot(obs$A,obs$Z)
plot(obs$Z,obs$Y)
plot(obs$W,obs$Z)
plot(obs$W,obs$Y)
plot(obs$A,obs$Y)

# glm_fit <- glm(formula = Y ~ W + A + W*A + Z,
#                family = binomial,
#                data = obs)
# summary(glm_fit)
# y_preds <- predict(glm_fit, type = "response")
# mse <- sum((y_preds - obs$Y)^2)
# auc <- auc(obs$Y, y_preds)
# print(paste0("    MSE: ", round(mse, 4), ", AUC: ", round(auc, 4)))
```


```{r get_true_psis_1_1}
# # Getting trul value of psi
# a_vec <- seq(0.5,5,0.5)
# psi0_a_0 <- c()
# psi0_a_1 <- c()
# 
# N = 1e+07
# data_0_0 <- generate_data_1_1(n=N, a=0, z=0)
# data_0_1 <- generate_data_1_1(n=N, a=0, z=1)
# 
# for (i in 1:length(a_vec)) {
#   a <- a_vec[i]
# 
#   data_a_0 <- generate_data_1_1(n=N, a=a, z=0)
#   psi0_a_0[i] <- mean(data_a_0$Y - data_0_0$Y)
# 
#   data_a_1 <- generate_data_1_1(n=N, a=a, z=1)
#   psi0_a_1[i] <- mean(data_a_1$Y - data_0_1$Y)
# }
# rm(data_0_0, data_0_1, data_a_0, data_a_1)
```

## n = 200
```{r simu_1_1_n200}
# set.seed(123)
# n=200
# B=1000
# lambda_scalers <- c(1.2, 1.1, 10^seq(from=0, to=-3, length=30))
# results_200 = run_simu(generate_data = generate_data_1_1, n=n, B=B, get_estimates = TRUE)
# save.image(file=here("data", "rdata", "02_simulation_1_1_200.RData"))
```

```{r}
load(here("data", "rdata", "02_simulation_1_1_200.RData"))
```

### results
```{r}
cat("Initial lambda mean:", results_200$lambda_scaler_1$lambda_summary[1,1])
cat("The selected undersmoothed lambda mean:", 0.0002045276)
scaler_picked = 0.0002045276/results_200$lambda_scaler_1$lambda_summary[1,1]
cat("The scaler picked:", scaler_picked)
```

#### CIs
```{r fig.height=22, fig.width=8}
p_list <- list()
for(z in c(0,1)){
  for (targ_par in paste0("ATE(",a_vec,",0)")) {
    p_list <- append(p_list, list(plot_perforences(results_200, z_para = z, target_para = targ_par, CI_forest_plot=T, scaler_picked = scaler_picked)))
  }
}

gridExtra::grid.arrange(grobs = p_list, ncol = 2,
                        top = textGrob("Estimations of ATEs \nfrom HAL over a grid of penalties",
                                       gp = gpar(fontsize = 20),  hjust = 0.5))
```

#### psi(a=0.5, z= 1)
```{r, fig.height=5.5, fig.width=5.5}
p <- plot_perforences(results_200, z_para = 1, target_para = "ATE(0.5,0)")
```

#### psi(a=2.5, z= 1)
```{r, fig.height=5.5, fig.width=5.5}
p <- plot_perforences(results_200, z_para = 1, target_para = "ATE(2.5,0)")
```

#### psi(a=5, z= 1)

```{r, fig.height=5.5, fig.width=5.5}
p <- plot_perforences(results_200, z_para = 1, target_para = "ATE(5,0)")
```

#### psi(a=0.5, z= 0)
Estimating ATE(0.5,0) with z  = 0
```{r, fig.height=5.5, fig.width=5.5}
p <- plot_perforences(results_200, z_para = 0, target_para = "ATE(0.5,0)")
```

#### psi(a=2.5, z= 0)
Estimating ATE(0.5,0) with z  = 0
```{r, fig.height=5.5, fig.width=5.5}
p <- plot_perforences(results_200, z_para = 0, target_para = "ATE(2.5,0)")
```

#### psi(a=5, z= 0)

```{r, fig.height=5.5, fig.width=5.5}
p <- plot_perforences(results_200, z_para = 0, target_para = "ATE(5,0)")
```


<!-- ## n = 500 -->
<!-- ```{r simu_1_1_n500} -->
<!-- set.seed(123) -->
<!-- n=500 -->
<!-- B=1000 -->
<!-- lambda_scalers <- c(1.2, 1.1, 10^seq(from=0, to=-3, length=30)) -->
<!-- results_500 = run_simu(generate_data = generate_data_1_1, n=n, B=B, get_estimates = TRUE) -->
<!-- save.image(file=here("data", "rdata", "02_simulation_1_1_500.RData")) -->
<!-- ``` -->




<!-- ## n = 1000 -->
<!-- ```{r simu_1_1_n1000} -->
<!-- set.seed(234) -->
<!-- n=1000 -->
<!-- B=1000 -->
<!-- results_1000 = run_simu(generate_data = generate_data_1_1, n=n, B=B, get_estimates = TRUE) -->
<!-- save.image(file=here("data", "rdata", "02_simulation_1_1_1000.RData")) -->
<!-- ``` -->


# Simulation #1_2
[Same as Simulation #1, but with a 3-way interaction]    
Data structure:  $O = (W, A, Z, Y)$ 

 * U - exogenous variables  
 * W - baseline covariate that is a measure of body condition  
 * A - treatment level based on W, continuous between 0 and 5  
 * Z - intermediate curve based on W and A
 * Y - outcome, indicator of an event ?  
   
 Underlying data generating process, $P_{U,X}$
 
* Exogenous variables:  
  + $U_A \sim Normal(\mu=0, \sigma^2 = 1^2)$  
  + $U_A \sim Normal(\mu=0, \sigma^2 = 2^2)$  
  + $U_Z \sim Uniform(min = 0, max = 1)$  
  + $U_Y \sim Uniform(min = 0, max = 1)$  
  
* Structural equations F and endogenous variables:  
  + $W =  U_W$  
  + $A = bound(2 - 0.5W + U_A, min=0, max=5)$  
  + $Z = \mathbf{I}[U_Z < expit(2-W-A)]$
  + $Y = \mathbf{I}[U_Y < expit(W + 5*A + Z - 0.5 * W * A + 0.3 * W * A * (Z+1) - 8)]$


```{r}
generate_data_1_2 <- function(n, a=NA, z=NA){
  # exogenous variables
  U_W <- rnorm(n, 0, 1)
  U_A <- rnorm(n, 0, 2)
  U_Z <- runif(n, 0, 1)
  U_Y <- runif(n, 0, 1)
  
  # endogenous variables
  W <- U_W
  
  if(is.na(a)){
    A <-  2 - 0.5*W + U_A
    A[A<=0] = 0
    A[A>=5] = 5
  } else {
    A <- rep(a, n)
  }
  
  if(is.na(z)){
    Z <- as.numeric(U_Z < plogis(2-W-A))
  } else {
    Z <- rep(z, n)
  }
  
  Y <- as.numeric(U_Y < plogis(W + 5*A + Z - 0.5 * W * A + 0.3 * W *A * (Z+1)- 8))
  
  # data frame
  O <- data.frame(W, A, Z, Y)
  return(O)
}

obs <- generate_data_1_2(n=10000)
print(summary(obs))
  
# check positivity violations
cat("Summary of A given W < -1:")
summary(obs$A[obs$W < -1])
cat("Summary of A given -1 < W <= 0:")
summary(obs$A[-1 <= obs$W & obs$W < 0])
cat("Summary of A given 0 < W <= 1:")
summary(obs$A[0 <= obs$W & obs$W < 1])
cat("Summary of A given 1 < W:")
summary(obs$A[1 <= obs$W])

par(mfrow=c(2,3))
plot(obs$W,obs$A)
plot(obs$A,obs$Z)
plot(obs$Z,obs$Y)
plot(obs$W,obs$Z)
plot(obs$W,obs$Y)
plot(obs$A,obs$Y)

# glm_fit <- glm(formula = Y ~ W + A + W*A + W*A*Z+ Z,
#                family = binomial,
#                data = obs)
# summary(glm_fit)
# y_preds <- predict(glm_fit, type = "response")
# mse <- sum((y_preds - obs$Y)^2)
# auc <- auc(obs$Y, y_preds)
# print(paste0("    MSE: ", round(mse, 4), ", AUC: ", round(auc, 4)))
```


```{r get_true_psis_1_2}
# # Getting trul value of psi
# a_vec <- seq(0.5,5,0.5)
# psi0_a_0 <- c()
# psi0_a_1 <- c()
# 
# N = 1e+07
# data_0_0 <- generate_data_1_2(n=N, a=0, z=0)
# data_0_1 <- generate_data_1_2(n=N, a=0, z=1)
# 
# for (i in 1:length(a_vec)) {
#   a <- a_vec[i]
# 
#   data_a_0 <- generate_data_1_2(n=N, a=a, z=0)
#   psi0_a_0[i] <- mean(data_a_0$Y - data_0_0$Y)
# 
#   data_a_1 <- generate_data_1_2(n=N, a=a, z=1)
#   psi0_a_1[i] <- mean(data_a_1$Y - data_0_1$Y)
# }
# rm(data_0_0, data_0_1, data_a_0, data_a_1)
```

## n = 200
```{r simu_1_2_n200}
# set.seed(123)
# n=200
# B=1000
# lambda_scalers <- c(1.2, 1.1, 10^seq(from=0, to=-3, length=30))
# results_200 = run_simu(generate_data = generate_data_1_2, n=n, B=B, get_estimates = TRUE)
# save.image(file=here("data", "rdata", "02_simulation_1_2_200.RData"))
```

```{r}
load(here("data", "rdata", "02_simulation_1_2_200.RData"))
```


### results
```{r}
cat("Initial lambda mean:", results_200$lambda_scaler_1$lambda_summary[1,1])
cat("The selected undersmoothed lambda mean:", 0.0001229773)
scaler_picked = 0.0001229773/results_200$lambda_scaler_1$lambda_summary[1,1]
cat("The scaler picked:", scaler_picked)
```

#### CIs
```{r fig.height=22, fig.width=8}
p_list <- list()
for(z in c(0,1)){
  for (targ_par in paste0("ATE(",a_vec,",0)")) {
    p_list <- append(p_list, list(plot_perforences(results_200, z_para = z, target_para = targ_par, CI_forest_plot=T, scaler_picked = scaler_picked)))
  }
}

gridExtra::grid.arrange(grobs = p_list, ncol = 2,
                        top = textGrob("Estimations of ATEs \nfrom HAL over a grid of penalties",
                                       gp = gpar(fontsize = 20),  hjust = 0.5))
```


#### psi(a=0.5, z= 1)
```{r, fig.height=5.5, fig.width=5.5}
p <- plot_perforences(results_200, z_para = 1, target_para = "ATE(0.5,0)")
```

#### psi(a=2.5, z= 1)
```{r, fig.height=5.5, fig.width=5.5}
p <- plot_perforences(results_200, z_para = 1, target_para = "ATE(2.5,0)")
```

#### psi(a=5, z= 1)

```{r, fig.height=5.5, fig.width=5.5}
p <- plot_perforences(results_200, z_para = 1, target_para = "ATE(5,0)")
```

#### psi(a=0.5, z= 0)
Estimating ATE(0.5,0) with z  = 0
```{r, fig.height=5.5, fig.width=5.5}
p <- plot_perforences(results_200, z_para = 0, target_para = "ATE(0.5,0)")
```

#### psi(a=2.5, z= 0)
Estimating ATE(0.5,0) with z  = 0
```{r, fig.height=5.5, fig.width=5.5}
p <- plot_perforences(results_200, z_para = 0, target_para = "ATE(2.5,0)")
```

#### psi(a=5, z= 0)

```{r, fig.height=5.5, fig.width=5.5}
p <- plot_perforences(results_200, z_para = 0, target_para = "ATE(5,0)")
```

<!-- ## n = 500 -->
<!-- ```{r simu_1_2_n500} -->
<!-- set.seed(123) -->
<!-- n=500 -->
<!-- B=1000 -->
<!-- results_500 = run_simu(generate_data = generate_data_1_2, n=n, B=B, get_estimates = TRUE) -->
<!-- save.image(file=here("data", "rdata", "02_simulation_1_2_500.RData")) -->
<!-- ``` -->



<!-- ## n = 1000 -->
<!-- ```{r simu_1_2_n1000} -->
<!-- set.seed(234) -->
<!-- n=1000 -->
<!-- B=1000 -->
<!-- results_1000 = run_simu(generate_data = generate_data_1_2, n=n, B=B, get_estimates = TRUE) -->
<!-- save.image(file=here("data", "rdata", "02_simulation_1_2_1000.RData")) -->
<!-- ``` -->




# Simulation #1_3
[Same as Simulation #1, but with a 3-way interaction and positivity violations]    

Data structure:  $O = (W, A, Z, Y)$ 

 * U - exogenous variables  
 * W - baseline covariate that is a measure of body condition  
 * A - treatment level based on W, continuous between 0 and 5  
 * Z - intermediate curve based on W and A
 * Y - outcome, indicator of an event ?  
   
 Underlying data generating process, $P_{U,X}$
 
* Exogenous variables:  
  + $U_A \sim Normal(\mu=0, \sigma^2 = 1^2)$  
  + $U_A \sim Normal(\mu=0, \sigma^2 = 1^2)$  
  + $U_Z \sim Uniform(min = 0, max = 1)$  
  + $U_Y \sim Uniform(min = 0, max = 1)$  
  
* Structural equations F and endogenous variables:  
  + $W =  U_W$  
  + $A = bound(2 - 0.5W + U_A, min=0, max=5)$  
  + $Z = \mathbf{I}[U_Z < expit(2-W-A)]$
  + $Y = \mathbf{I}[U_Y < expit(W + 5*A + Z - 0.5 * W * A + 0.3 * W * A * (Z+1) - 8)]$


```{r}
generate_data_1_3 <- function(n, a=NA, z=NA){
  # exogenous variables
  U_W <- rnorm(n, 0, 1)
  U_A <- rnorm(n, 0, 1)
  U_Z <- runif(n, 0, 1)
  U_Y <- runif(n, 0, 1)
  
  # endogenous variables
  W <- U_W
  
  if(is.na(a)){
    A <-  2 - 0.5*W + U_A
    A[A<=0] = 0
    A[A>=5] = 5
  } else {
    A <- rep(a, n)
  }
  
  if(is.na(z)){
    Z <- as.numeric(U_Z < plogis(2-W-A))
  } else {
    Z <- rep(z, n)
  }
  
  Y <- as.numeric(U_Y < plogis(W + 5*A + Z - 0.5 * W * A + 0.3 * W *A * (Z+1)- 8))
  
  # data frame
  O <- data.frame(W, A, Z, Y)
  return(O)
}

obs <- generate_data_1_3(n=10000)
print(summary(obs))
  
# check positivity violations
cat("Summary of A given W < -1:")
summary(obs$A[obs$W < -1])
cat("Summary of A given -1 < W <= 0:")
summary(obs$A[-1 <= obs$W & obs$W < 0])
cat("Summary of A given 0 < W <= 1:")
summary(obs$A[0 <= obs$W & obs$W < 1])
cat("Summary of A given 1 < W:")
summary(obs$A[1 <= obs$W])

par(mfrow=c(2,3))
plot(obs$W,obs$A)
plot(obs$A,obs$Z)
plot(obs$Z,obs$Y)
plot(obs$W,obs$Z)
plot(obs$W,obs$Y)
plot(obs$A,obs$Y)

# glm_fit <- glm(formula = Y ~ W + A + W*A + W*A*Z+ Z,
#                family = binomial,
#                data = obs)
# summary(glm_fit)
# y_preds <- predict(glm_fit, type = "response")
# mse <- sum((y_preds - obs$Y)^2)
# auc <- auc(obs$Y, y_preds)
# print(paste0("    MSE: ", round(mse, 4), ", AUC: ", round(auc, 4)))
```


```{r get_true_psis_1_3}
# # Getting trul value of psi
# a_vec <- seq(0.5,5,0.5)
# psi0_a_0 <- c()
# psi0_a_1 <- c()
# 
# N = 1e+07
# data_0_0 <- generate_data_1_3(n=N, a=0, z=0)
# data_0_1 <- generate_data_1_3(n=N, a=0, z=1)
# 
# for (i in 1:length(a_vec)) {
#   a <- a_vec[i]
# 
#   data_a_0 <- generate_data_1_3(n=N, a=a, z=0)
#   psi0_a_0[i] <- mean(data_a_0$Y - data_0_0$Y)
# 
#   data_a_1 <- generate_data_1_3(n=N, a=a, z=1)
#   psi0_a_1[i] <- mean(data_a_1$Y - data_0_1$Y)
# }
# rm(data_0_0, data_0_1, data_a_0, data_a_1)
```

## n = 200
```{r simu_1_3_n200}
# set.seed(123)
# n=200
# B=1000
# lambda_scalers <- c(1.2, 1.1, 10^seq(from=0, to=-3, length=30))
# results_200 = run_simu(generate_data = generate_data_1_3, n=n, B=B, get_estimates = TRUE)
# save.image(file=here("data", "rdata", "02_simulation_1_3_200.RData"))
```

```{r}
load(here("data", "rdata", "02_simulation_1_3_200.RData"))
```



### results
### results
```{r}
cat("Initial lambda mean:", results_200$lambda_scaler_1$lambda_summary[1,1])
cat("The selected undersmoothed lambda mean:", 0.0001897926)
scaler_picked = 0.0001897926/results_200$lambda_scaler_1$lambda_summary[1,1]
cat("The scaler picked:", scaler_picked)
```

#### CIs
```{r fig.height=22, fig.width=8}
p_list <- list()
for(z in c(0,1)){
  for (targ_par in paste0("ATE(",a_vec,",0)")) {
    p_list <- append(p_list, list(plot_perforences(results_200, z_para = z, target_para = targ_par, CI_forest_plot=T, scaler_picked = scaler_picked)))
  }
}

gridExtra::grid.arrange(grobs = p_list, ncol = 2,
                        top = textGrob("Estimations of ATEs \nfrom HAL over a grid of penalties",
                                       gp = gpar(fontsize = 20),  hjust = 0.5))
```

#### psi(a=0.5, z= 1)
```{r, fig.height=5.5, fig.width=5.5}
p <- plot_perforences(results_200, z_para = 1, target_para = "ATE(0.5,0)")
```

#### psi(a=2.5, z= 1)
```{r, fig.height=5.5, fig.width=5.5}
p <- plot_perforences(results_200, z_para = 1, target_para = "ATE(2.5,0)")
```

#### psi(a=5, z= 1)

```{r, fig.height=5.5, fig.width=5.5}
p <- plot_perforences(results_200, z_para = 1, target_para = "ATE(5,0)")
```

#### psi(a=0.5, z= 0)
Estimating ATE(0.5,0) with z  = 0
```{r, fig.height=5.5, fig.width=5.5}
p <- plot_perforences(results_200, z_para = 0, target_para = "ATE(0.5,0)")
```

#### psi(a=2.5, z= 0)
Estimating ATE(0.5,0) with z  = 0
```{r, fig.height=5.5, fig.width=5.5}
p <- plot_perforences(results_200, z_para = 0, target_para = "ATE(2.5,0)")
```

#### psi(a=5, z= 0)

```{r, fig.height=5.5, fig.width=5.5}
p <- plot_perforences(results_200, z_para = 0, target_para = "ATE(5,0)")
```


<!-- ## n = 500 -->
<!-- ```{r simu_1_3_n500} -->
<!-- set.seed(123) -->
<!-- n=500 -->
<!-- B=1000 -->
<!-- results_500 = run_simu(generate_data = generate_data_1_3, n=n, B=B, get_estimates = TRUE) -->
<!-- save.image(file=here("data", "rdata", "02_simulation_1_3_500.RData")) -->
<!-- ``` -->



<!-- ## n = 1000 -->
<!-- ```{r simu_1_3_n1000} -->
<!-- set.seed(234) -->
<!-- n=1000 -->
<!-- B=1000 -->
<!-- results_1000 = run_simu(generate_data = generate_data_1_3, n=n, B=B, get_estimates = TRUE) -->
<!-- save.image(file=here("data", "rdata", "02_simulation_1_3_1000.RData")) -->
<!-- ``` -->


<!-- ### results -->
<!-- ```{r} -->
<!-- load(here("data", "rdata", "02_simulation_1_3_1000.RData")) -->

<!-- results_1000[[1]] <- results_1000[[1]] %>% mutate_if(is.numeric, round, digits=4)  -->
<!-- results_1000[[2]] <- results_1000[[2]] %>% mutate_if(is.numeric, round, digits=4)  -->

<!-- print(results_1000) -->
<!-- ``` -->



```{r}
# knitr::purl(here("scripts", "2_simulations.Rmd"))
```